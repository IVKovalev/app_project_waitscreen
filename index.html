<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Waking up the app…</title>
  <style>
    :root { --fg:#223; --muted:#667; --primary:#1976d2; }
    html,body { height:100%; margin:0; font-family:system-ui, Arial, sans-serif; background:#f5f7fb; color:var(--fg); }
    .wrap { min-height:100%; display:flex; align-items:center; justify-content:center; padding:24px; }
    .card { width:min(520px, 92vw); background:#fff; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.08); padding:20px; text-align:center; }
    .img { width:160px; height:160px; margin:8px auto 12px; background:url("./img/wake.png") center/contain no-repeat; }
    h1 { margin:6px 0 8px; font-size:22px; }
    p { margin:6px 0; color:var(--muted); }
    .row { margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    button { cursor:pointer; border:0; border-radius:8px; padding:10px 14px; }
    .btn-primary { background:var(--primary); color:#fff; }
    .btn-ghost { background:#eef3fb; color:var(--primary); }
    .timer { font-variant-numeric: tabular-nums; font-weight:600; }
    .hint { font-size:12px; color:#8a8f9a; margin-top:8px; }
    .log { margin-top:10px; font-size:12px; max-height:120px; overflow:auto; text-align:left; background:#fafbff; border:1px solid #eef; border-radius:8px; padding:8px; }
    .ok { color:#1a7f37; }
    .warn { color:#a15c00; }
    .err { color:#b22222; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="img" aria-hidden="true"></div>
      <h1>Waking up the app…</h1>
      <p>Please hold on <span class="timer" id="timer">00:00</span></p>
      <div class="row">
        <button class="btn-primary" id="start">Start / Retry</button>
        <button class="btn-ghost" id="open">Open now</button>
      </div>
      <div class="hint">We ping the server until it’s ready, then auto-redirects.</div>
      <div class="log" id="log" role="log" aria-live="polite"></div>
    </div>
  </div>

  <script>
    // === SETTINGS (под твой бэкенд) ===
    const BACKEND = "https://app-project-hospitality.onrender.com";
    const HEALTH = BACKEND + "/health";
    const REDIRECT_TO = BACKEND + "/";

    // тайминги
    const TIMEOUT_MS = 6000;      // таймаут одиночного пинга
    const MAX_WAIT_MS = 120000;   // общий лимит ожидания (2 мин)
    const START_DELAY_MS = 800;   // небольшая пауза перед первым пингом
    const INITIAL_BACKOFF = 1500; // стартовый бэкофф
    const MAX_BACKOFF = 7000;     // максимум между попытками
    // ================================

    const $log = document.getElementById("log");
    const $timer = document.getElementById("timer");
    const $start = document.getElementById("start");
    const $open = document.getElementById("open");

    let running = false;
    let startTs = 0;
    let timerId;

    function log(line, cls="") {
      const dt = new Date().toLocaleTimeString();
      const div = document.createElement("div");
      if (cls) div.className = cls;
      div.textContent = `[${dt}] ${line}`;
      $log.appendChild(div);
      $log.scrollTop = $log.scrollHeight;
    }

    function format(ms) {
      const s = Math.floor(ms/1000);
      const m = String(Math.floor(s/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return `${m}:${ss}`;
    }

    function startTimer() {
      startTs = Date.now();
      timerId = setInterval(() => { $timer.textContent = format(Date.now() - startTs); }, 500);
    }
    function stopTimer() { clearInterval(timerId); }

    async function pingOnce(signal) {
      const r = await fetch(HEALTH, { method:"GET", cache:"no-store", signal });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const txt = (await r.text()||"").trim().toLowerCase();
      if (txt !== "ok") throw new Error(`Bad payload: ${txt}`);
      return true;
    }
    function delay(ms){ return new Promise(res => setTimeout(res, ms)); }

    async function warmUp() {
      if (running) return;
      running = true; $start.disabled = true;
      log("Starting warm-up…");
      startTimer();

      const deadline = Date.now() + MAX_WAIT_MS;
      let backoff = INITIAL_BACKOFF;
      await delay(START_DELAY_MS);

      while (Date.now() < deadline) {
        const ctl = new AbortController();
        const to = setTimeout(() => ctl.abort(), TIMEOUT_MS);
        try {
          await pingOnce(ctl.signal);
          log("Server is ready ✓", "ok");
          stopTimer();
          await delay(400); // чуть-чуть показать зелёную галочку
          window.location.href = REDIRECT_TO;
          return;
        } catch (e) {
          const msg = String(e.message || e);
          if (msg.includes("429")) {
            log("Too many requests, backing off…", "warn");
            backoff = Math.min(backoff * 1.5, MAX_BACKOFF);
          } else if (msg.includes("AbortError")) {
            log("Timeout, retrying…", "warn");
            backoff = Math.min(backoff * 1.2, MAX_BACKOFF);
          } else {
            log(`Error: ${msg}. Retrying…`, "err");
            backoff = Math.min(backoff * 1.3, MAX_BACKOFF);
          }
          clearTimeout(to);
          await delay(backoff);
        } finally {
          clearTimeout(to);
        }
      }

      stopTimer();
      running = false; $start.disabled = false;
      log("Gave up after max wait. Try again.", "err");
    }

    $start.addEventListener("click", warmUp);
    $open.addEventListener("click", () => window.location.href = REDIRECT_TO);
    warmUp(); // автостарт
  </script>
</body>
</html>
